import React, { useState, useEffect, useCallback } from "react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { toast } from "sonner";
import { 
  BarChart3, 
  Calculator, 
  Download, 
  Layers,
  LineChart, 
  MapPin,
  Settings, 
  Sun,
  Zap 
} from "lucide-react";
import { calculateSolarEnergy, calculateMultiplePVSystems, MultiplePVSystemsParams } from "@/utils/solarEnergyCalculation";
import { InverterParams, SolarCalculationResult, SolarParams } from "@/types/solarCalculations";
import { PolygonConfig } from "./area-calculator/types";
import SystemConfiguration from "../advanced-solar-calculator/SystemConfiguration";
import ComponentSelector from "./ComponentSelector";
import EfficiencyAdjustment from "./EfficiencyAdjustment";
import ProductionResults from "./ProductionResults";
import AreaCalculator from "./AreaCalculator";
import LocationInputs from "../advanced-solar-inputs/LocationInputs";
import { ACSideConfiguration, ACConfiguration } from "./ACSideConfiguration";
import { Card } from "@/components/ui/card";
import { getArrayTypeForStructure } from "./area-calculator/utils/drawingUtils";

const AdvancedSolarCalculator: React.FC = () => {
  // Location parameters
  const [latitude, setLatitude] = useState(40.7128);
  const [longitude, setLongitude] = useState(-74.0060);
  const [timezone, setTimezone] = useState("America/New_York");
  const [country, setCountry] = useState("United States");
  const [city, setCity] = useState("New York");
  
  // PV system parameters
  const [tilt, setTilt] = useState(30);
  const [azimuth, setAzimuth] = useState(180); // 180 = south
  const [arrayType, setArrayType] = useState(0); // 0 = Fixed (open rack)
  const [losses, setLosses] = useState(14.08); // Default value
  const [moduleEfficiency, setModuleEfficiency] = useState(0.2); // 20%
  const [performanceRatio, setPerformanceRatio] = useState(0.8); // 80%
  const [capacity, setCapacity] = useState(10); // 10 kW
  const [moduleArea, setModuleArea] = useState(1.7); // m�
  const [moduleWattPeak, setModuleWattPeak] = useState(400); // Wp
  
  // Component selection
  const [selectedPanel, setSelectedPanel] = useState(null);
  const [selectedInverter, setSelectedInverter] = useState(null);
  
  // Area calculation results
  const [areaBasedLayout, setAreaBasedLayout] = useState(null);
  const [polygonConfigs, setPolygonConfigs] = useState([]);
  
  // Inverter configuration
  const [inverterParams, setInverterParams] = useState<InverterParams | null>(null);
  const [dcAcRatio, setDcAcRatio] = useState(120); // Fixed value
  
  // AC Side configuration
  const [acConfiguration, setACConfiguration] = useState<ACConfiguration | null>(null);
  
  // Results state
  const [results, setResults] = useState<SolarCalculationResult | null>(null);
  const [calculating, setCalculating] = useState(false);
  const [activeTab, setActiveTab] = useState("components");
  
  // Map image state
  const [mapImage, setMapImage] = useState<string | null>(null);
  
  // Map image state
  const [capturedMapImage, setCapturedMapImage] = useState<string | null>(null);
  const [capturedMapMetadata, setCapturedMapMetadata] = useState<{
    totalCapacity?: number;
    moduleCount?: number;
    totalArea?: number;
    structureType?: string;
    timestamp?: Date;
  } | null>(null);

  // Calculate total inverter count and output parameters
  const calculateInverterParameters = () => {
    if (!selectedInverter || !capacity) {
      return {
        inverter_model: "Default Inverter",
        quantity: 1,
        dc_ac_ratio: 1.2,
        power: 5000,
        efficiency: 0.96
      };
    }
    
    const inverterPower = selectedInverter.max_power || selectedInverter.power_rating || 5000; // Default 5kW
    const inverterCount = Math.ceil(capacity * 1000 / inverterPower);
    const dcAcRatio = (capacity * 1000) / (inverterPower * inverterCount); // DC/AC ratio
    const efficiency = selectedInverter.efficiency || 0.96; // Default 96% efficiency
    
    return {
      inverter_model: selectedInverter.model || selectedInverter.name || "Selected Inverter",
      quantity: inverterCount,
      dc_ac_ratio: dcAcRatio,
      power: inverterPower,
      efficiency: typeof efficiency === 'string' ? parseFloat(efficiency) / 100 : efficiency
    };
  };

  // Handler for AC configuration changes
  const handleACConfigurationChange = (config: ACConfiguration) => {
    setACConfiguration(config);
    
    // Update system losses to include AC losses
    if (config.totalACLosses > 0) {
      const acLossPercentage = (config.totalACLosses / capacity) * 100;
      setLosses(prev => prev + acLossPercentage);
    }
  };

  // Update module parameters when panel is selected - wrapped in useCallback to fix dependency issue
  const updateModuleParameters = useCallback(() => {
    if (selectedPanel) {
      // Extract panel dimensions and calculate area, with proper fallbacks
      let panelArea = 0;
      
      // First check for explicit panel_area_m2 field
      if (selectedPanel.panel_area_m2 && selectedPanel.panel_area_m2 > 0) {
        panelArea = selectedPanel.panel_area_m2;
        console.log(`Using panel_area_m2 directly: ${panelArea.toFixed(3)}m�`);
      } 
      // Then check for module_length and module_width fields (in mm)
      else if (selectedPanel.module_length && selectedPanel.module_width) {
        panelArea = (selectedPanel.module_length * selectedPanel.module_width) / 1000000;
        console.log(`Using module_length � module_width: ${panelArea.toFixed(3)}m�`);
      }
      // Then check for length and width fields (in mm)
      else if (selectedPanel.length && selectedPanel.width) {
        panelArea = (selectedPanel.length * selectedPanel.width) / 1000000;
        console.log(`Using length � width: ${panelArea.toFixed(3)}m�`);
      }
      // Finally fall back to standard dimensions
      else {
        const defaultLength = 1700; // mm
        const defaultWidth = 1000; // mm
        panelArea = (defaultLength * defaultWidth) / 1000000;
        console.log(`Using default dimensions: ${panelArea.toFixed(3)}m�`);
      }
      
      // Correctly extract panel efficiency from all possible fields
      let panelEfficiency = 20; // default fallback %
      
      if (selectedPanel.efficiency_percent && selectedPanel.efficiency_percent > 0) {
        panelEfficiency = selectedPanel.efficiency_percent;
        console.log(`Using panel efficiency_percent: ${panelEfficiency}%`);
      } else if (selectedPanel.efficiency && selectedPanel.efficiency > 0) {
        // Handle efficiency as decimal or percentage
        panelEfficiency = selectedPanel.efficiency > 1 ? selectedPanel.efficiency : selectedPanel.efficiency * 100;
        console.log(`Using panel efficiency: ${panelEfficiency}%`);
      }
      
      // Enhanced panel power extraction
      let panelPower = 0;
      
      console.log('SelectedPanel object:', selectedPanel);
      
      const possiblePowerFields = [
        'nominal_power_w',
        'power_rating',
        'power',
        'wattage',
        'watt_peak',
        'max_power',
        'pmax',
        'rated_power',
        'module_power',
        'wp',
        'w',
      ];
      
      for (const field of possiblePowerFields) {
        let value = selectedPanel[field];
        if (typeof value === 'string') {
          value = parseFloat(value.replace(/[^\d.]/g, ''));
        }
        if (typeof value === 'number' && value > 0) {
          panelPower = value;
          console.log(`Panel power found in field '${field}':`, panelPower);
          break;
        }
      }
      
      // Handle the specific error case (34kW bug)
      if (panelPower > 30000 && panelPower < 40000) {
        panelPower = panelPower / 100;
        console.log(`Converting specific error case panel from 34kW to ${panelPower}W`);
      }
      
      if (!panelPower || panelPower <= 0) {
        // Calculate power from area and efficiency as fallback
        panelPower = Math.round(panelArea * 1000 * panelEfficiency);
        console.warn('No power value available - calculating from area and efficiency:', panelPower);
      }
      
      setModuleArea(panelArea);
      setModuleEfficiency(panelEfficiency / 100);
      setModuleWattPeak(panelPower);
      
      console.log(`Panel parameters updated: ${panelArea.toFixed(2)}m�, ${panelEfficiency}%, ${panelPower}W`);
    }
  }, [selectedPanel, setModuleArea, setModuleEfficiency, setModuleWattPeak]);

  // When components are selected, automatically go to location tab
  useEffect(() => {
    if (selectedPanel && selectedInverter) {
      updateModuleParameters();
    }
  }, [selectedPanel, selectedInverter, updateModuleParameters]);

  // Enhance the handleAreaCalculation function with additional debugging and safeguards
  const handleAreaCalculation = (capacityKw: number, areaM2: number, moduleCount: number, configs?: PolygonConfig[]) => {
    console.log("Area calculation received:", { capacityKw, areaM2, moduleCount, configCount: configs?.length });
    
    // Validate incoming data
    if (isNaN(capacityKw) || capacityKw === undefined) {
      console.error("Invalid capacity value received:", capacityKw);
      capacityKw = 0;
    }
    
    if (moduleCount > 0 && capacityKw === 0) {
      console.warn("Modules placed but capacity is zero - recalculating");
      // More robust panel power determination with improved consistency
      console.log("Selected panel for capacity calculation:", selectedPanel);
      
      let panelPower = 0;
      
      // Check for nominal_power_w first as it's the most reliable source
      if (selectedPanel?.nominal_power_w && selectedPanel.nominal_power_w > 0) {
        panelPower = selectedPanel.nominal_power_w;
        console.log(`Using nominal_power_w: ${panelPower}W`);
      }
      // ONLY handle the specific edge case of 34kW panels
      else if (selectedPanel?.power_rating && selectedPanel.power_rating > 30000 && selectedPanel.power_rating < 40000) {
        panelPower = selectedPanel.power_rating / 100; // Convert from 34000W to 340W
        console.log(`Converting specific error case panel from ${selectedPanel.power_rating}W to ${panelPower}W`);
      } 
      else if (selectedPanel?.power && selectedPanel.power > 30000 && selectedPanel.power < 40000) {
        panelPower = selectedPanel.power / 100; // Convert from 34000W to 340W
        console.log(`Converting specific error case panel from ${selectedPanel.power}W to ${panelPower}W`);
      }
      // For all other values, use the actual power values
      else if (selectedPanel?.power_rating && selectedPanel.power_rating > 0) {
        panelPower = selectedPanel.power_rating;
        console.log(`Using actual panel power_rating: ${panelPower}W`);
      } 
      else if (selectedPanel?.power && selectedPanel.power > 0) {
        panelPower = selectedPanel.power;
        console.log(`Using actual panel power: ${panelPower}W`);
      } 
      else {
        // Use default panel power if no valid value found
        panelPower = 400;
        console.warn("No valid panel power found, using default:", panelPower);
      }
      
      // Calculate capacity with the extracted power value
      capacityKw = (moduleCount * panelPower) / 1000;
      console.log("Recalculated capacity:", capacityKw.toFixed(2), "kW from", moduleCount, "modules at", panelPower, "W each");
    }
    
    setCapacity(capacityKw);
    if (configs) {
      setPolygonConfigs(configs);
    }
  };

  const handleCalculate = async () => {
    if (!latitude || !longitude || !capacity) {
      toast.error("Please provide location and system capacity");
      return;
    }

    if (!selectedPanel) {
      toast.error("Please select a solar panel");
      return;
    }

    setCalculating(true);
    
    try {
      console.log("Starting calculation with parameters:", {
        capacity,
        tilt,
        azimuth,
        losses,
        polygonConfigs: polygonConfigs?.length
      });

      let calculationResults;

      if (polygonConfigs && polygonConfigs.length > 0) {
        console.log("Using multiple polygon configurations for calculation");
        
        const pvSystemsParams: MultiplePVSystemsParams = {
          latitude,
          longitude,
          timezone,
          module_efficiency: moduleEfficiency,
          performance_ratio: performanceRatio,
          module_area: moduleArea,
          module_watt_peak: moduleWattPeak,
          inverterParams: calculateInverterParameters(),
          losses: losses,
          pvSystems: polygonConfigs.map((config, index) => ({
            structureType: config.structureType,
            area: config.area,
            moduleCount: config.moduleCount,
            capacityKw: config.capacityKw,
            azimuth: config.azimuth,
            tiltAngle: config.tiltAngle
          }))
        };
        
        calculationResults = await calculateMultiplePVSystems(pvSystemsParams);
        console.log("Multiple PV systems calculation completed:", calculationResults);
      } else {
        console.log("Using single system calculation");
        
        const solarParams: SolarParams = {
          plant_capacity_kw: capacity,
          surface_tilt: tilt,
          surface_azimuth: azimuth,
          latitude,
          longitude,
          timezone,
          array_type: arrayType,
          losses,
          module_efficiency: moduleEfficiency,
          performance_ratio: performanceRatio,
          module_area: moduleArea,
          module_watt_peak: moduleWattPeak
        };

        calculationResults = await calculateSolarEnergy(solarParams);
        console.log("Single system calculation completed:", calculationResults);
      }

      setResults(calculationResults);
      setActiveTab("acconfig"); // Navigate to AC configuration after calculation
      toast.success("Solar energy calculation completed!");
      
    } catch (error) {
      console.error("Calculation error:", error);
      toast.error("Failed to calculate solar energy production");
    } finally {
      setCalculating(false);
    }
  };
  
  const handleMapImageCaptured = (imageDataUrl: string, metadata?: {
    totalCapacity?: number;
    moduleCount?: number;
    totalArea?: number;
    structureType?: string;
    timestamp?: Date;
  }) => {
    setCapturedMapImage(imageDataUrl);
    if (metadata) {
      setCapturedMapMetadata(metadata);
      console.log("Map image captured and stored with metadata:", metadata);
    } else {
      console.log("Map image captured and stored");
    }
  };

  return (
    <div className="w-full max-w-6xl mx-auto pb-8">
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="mb-4">
          <TabsTrigger value="components">
            <Calculator className="h-4 w-4 mr-2" />
            Components
          </TabsTrigger>
          <TabsTrigger value="location">
            <MapPin className="h-4 w-4 mr-2" />
            Location
          </TabsTrigger>
          <TabsTrigger value="areas" disabled={!selectedPanel}>
            <Layers className="h-4 w-4 mr-2" />
            PV Areas
          </TabsTrigger>
          <TabsTrigger value="acconfig" disabled={!results}>
            <Zap className="h-4 w-4 mr-2" />
            AC Configuration
          </TabsTrigger>
          <TabsTrigger value="results" disabled={!acConfiguration}>
            <BarChart3 className="h-4 w-4 mr-2" />
            Results
          </TabsTrigger>
        </TabsList>
        
        <TabsContent value="components">
          <ComponentSelector 
            onPanelSelect={setSelectedPanel}
            selectedPanel={selectedPanel}
          />
          
          <div className="flex justify-between mt-6">
            <div></div>
            <Button
              onClick={() => setActiveTab("location")}
              className="bg-primary"
              disabled={!selectedPanel}
            >
              Continue to Location
            </Button>
          </div>
        </TabsContent>
        
        <TabsContent value="location">
          <Card className="p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <MapPin className="h-5 w-5 text-amber-500" />
              Location Settings
            </h2>
            
            <LocationInputs 
              latitude={latitude}
              longitude={longitude}
              timezone={timezone}
              country={country}
              city={city}
              setLatitude={setLatitude}
              setLongitude={setLongitude}
              setTimezone={setTimezone}
              setCountry={setCountry}
              setCity={setCity}
            />
          </Card>
          
          <div className="flex justify-between mt-6">
            <Button
              onClick={() => setActiveTab("components")}
              variant="outline"
            >
              Back
            </Button>
            <Button
              onClick={() => setActiveTab("areas")}
              className="bg-primary"
              disabled={!latitude || !longitude}
            >
              Continue to PV Areas
            </Button>
          </div>
        </TabsContent>
        
        <TabsContent value="areas">
          {selectedPanel ? (
            <>
            <AreaCalculator 
              selectedPanel={selectedPanel} 
              onCapacityCalculated={handleAreaCalculation}
              onMapImageCaptured={handleMapImageCaptured}
              latitude={latitude}
              longitude={longitude}
            />
              
              {/* Configuration section moved from separate tab */}
              {polygonConfigs && polygonConfigs.length > 0 && (
                <div className="mt-8">
                  <h2 className="text-xl font-semibold mb-4">System Configuration</h2>
          <SystemConfiguration
            arrayType={arrayType}
            losses={losses}
            polygonConfigs={polygonConfigs}
            onArrayTypeChange={setArrayType}
            onLossesChange={setLosses}
            selectedInverter={selectedInverter}
            onInverterSelect={setSelectedInverter}
            selectedPanel={selectedPanel}
            totalSystemCapacity={capacity}
            onACConfigurationChange={handleACConfigurationChange}
          />
          
          {polygonConfigs.length > 0 && (
            <div className="mt-6 bg-muted/20 p-4 rounded-md border">
              <h3 className="text-lg font-semibold mb-2">Multiple Installation Areas</h3>
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead className="bg-muted/50">
                    <tr>
                      <th className="px-3 py-2 text-left text-sm">Area</th>
                      <th className="px-3 py-2 text-left text-sm">Structure</th>
                      <th className="px-3 py-2 text-right text-sm">Size (m�)</th>
                      <th className="px-3 py-2 text-center text-sm">Azimuth</th>
                      <th className="px-3 py-2 text-center text-sm">Tilt</th>
                      <th className="px-3 py-2 text-right text-sm">Modules</th>
                      <th className="px-3 py-2 text-right text-sm">Capacity (kWp)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {polygonConfigs.map((config, index) => (
                      <tr key={`poly-${index}`} className="border-t border-muted">
                        <td className="px-3 py-2 text-sm font-medium">Area {index + 1}</td>
                        <td className="px-3 py-2 text-sm">
                          {config.structureType === 'ballasted' && 'Ballasted Roof'}
                          {config.structureType === 'fixed_tilt' && 'Fixed Tilt Elevated'}
                          {config.structureType === 'ground_mount_tables' && 'Ground Mount Tables'}
                          {config.structureType === 'carport' && 'Carport'}
                          {config.structureType === 'pv_table_free_form' && 'PV Table - Free Form'}
                        </td>
                        <td className="px-3 py-2 text-sm text-right">{config.area.toFixed(1)}</td>
                        <td className="px-3 py-2 text-sm text-center">
                          {config.azimuth.toFixed(0)}�
                        </td>
                        <td className="px-3 py-2 text-sm text-center">
                          {config.tiltAngle.toFixed(0)}�
                        </td>
                        <td className="px-3 py-2 text-sm text-right">{config.moduleCount}</td>
                        <td className="px-3 py-2 text-sm text-right">{config.capacityKw.toFixed(1)}</td>
                      </tr>
                    ))}
                    <tr className="border-t border-muted bg-muted/20 font-medium">
                      <td className="px-3 py-2 text-sm">Total</td>
                      <td className="px-3 py-2 text-sm">-</td>
                      <td className="px-3 py-2 text-sm text-right">
                        {polygonConfigs.reduce((sum, config) => sum + config.area, 0).toFixed(1)}
                      </td>
                      <td className="px-3 py-2 text-sm text-center">-</td>
                      <td className="px-3 py-2 text-sm text-center">-</td>
                      <td className="px-3 py-2 text-sm text-right">
                        {polygonConfigs.reduce((sum, config) => sum + config.moduleCount, 0)}
                      </td>
                      <td className="px-3 py-2 text-sm text-right">
                        {polygonConfigs.reduce((sum, config) => sum + config.capacityKw, 0).toFixed(1)}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div className="mt-4 text-sm bg-muted/30 p-2 rounded">
                <p><strong>Note:</strong> Each PV area will be calculated as a separate system using its individual parameters (tilt, azimuth, structure type), then combined for the final energy calculation.</p>
              </div>
            </div>
          )}
              </div>
              )}
            </>
          ) : (
            <div className="p-8 text-center">
              <p>Please select a panel before defining array areas.</p>
              <Button
                onClick={() => setActiveTab("components")}
                className="mt-4"
              >
                Go to Component Selection
              </Button>
            </div>
          )}
          
          <div className="flex justify-between mt-6">
            <Button
              onClick={() => setActiveTab("location")}
              variant="outline"
            >
              Back
            </Button>
            <Button
              onClick={handleCalculate}
              className="bg-primary"
              disabled={calculating || !latitude || !longitude || !capacity || !(polygonConfigs && polygonConfigs.length > 0)}
            >
              {calculating ? (
                <>Calculating...</>
              ) : (
                <>Calculate & Continue to AC Configuration</>
              )}
            </Button>
          </div>
        </TabsContent>

        {/* AC Configuration Tab */}
<TabsContent value="acconfig">
  {results && selectedInverter && (() => {
    // Calculate AC configuration parameters (separate from InverterParams)
    const inverterPower = selectedInverter.max_power || selectedInverter.power_rating || 5000; // Default 5kW
    const inverterCount = Math.ceil(capacity * 1000 / inverterPower);
    const inverterOutputVoltage = selectedInverter.output_voltage || 400; // Default 400V
    const inverterOutputCurrent = inverterPower / (Math.sqrt(3) * inverterOutputVoltage); // 3-phase current

    return (
      <ACSideConfiguration
        systemSize={capacity}
        inverterPower={inverterPower / 1000} // Convert to kW
        inverterCount={inverterCount}
        inverterOutputVoltage={inverterOutputVoltage}
        inverterOutputCurrent={inverterOutputCurrent}
        onConfigurationChange={handleACConfigurationChange}
      />
    );
  })()}
          
          <div className="flex justify-between mt-6">
            <Button
              onClick={() => setActiveTab("areas")}
              variant="outline"
            >
              Back to PV Areas
            </Button>
            <Button
              onClick={() => setActiveTab("results")}
              className="bg-primary"
              disabled={!acConfiguration}
            >
              Continue to Results
            </Button>
          </div>
        </TabsContent>
        
        {/* Keep empty configuration tab to maintain structure but hide from user */}
        <TabsContent value="configuration" className="hidden">
        </TabsContent>
        
        <TabsContent value="results">
          {results && (
            <ProductionResults 
              results={results} 
              systemParams={{
                capacity,
                tilt,
                azimuth,
                moduleEfficiency,
                losses,
                arrayType,
                latitude,
                longitude,
                timezone
              }}
              selectedPanel={selectedPanel}
              selectedInverter={selectedInverter}
              polygonConfigs={polygonConfigs}
              mapImage={capturedMapImage}
              onNewCalculation={() => setActiveTab("components")}
            />
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default AdvancedSolarCalculator;
